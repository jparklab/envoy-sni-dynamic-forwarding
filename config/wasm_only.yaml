node:
  id: server
static_resources:
  listeners:
  - name: listener_0
    address:
      socket_address:
        protocol: TCP
        address: 0.0.0.0
        port_value: 10000
    listener_filters:
    - name: envoy.filters.listener.tls_inspector
      typed_config:
        "@type": type.googleapis.com/envoy.extensions.filters.listener.tls_inspector.v3.TlsInspector
    filter_chains:
    - filters:
      # ext_auth that sets dynamic metadata based on sni
#      - name: envoy.filters.network.ext_authz
#        typed_config:
#          "@type": type.googleapis.com/envoy.extensions.filters.network.ext_authz.v3.ExtAuthz
#          stat_prefix: ext_authz
#          grpc_service:
#            envoy_grpc:
#              cluster_name: ext_authz
#          include_tls_session: true
#          transport_api_version: V3
      - name: envoy.filters.network.wasm
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.wasm.v3.Wasm
          config:
            name: "tcp_plugin"
            vm_config:
              runtime: "envoy.wasm.runtime.v8"
              code:
                local:
                  #filename: "/home/christoph/envoy-sni-dynamic-forwarding/wasm-plugin/tcp-plugin.wasm"
                  filename: "/home/christoph/envoy-sni-dynamic-forwarding/wasm-plugin-1/target/wasm32-wasip1/release/proxy_wasm_example_grpc_auth_random.wasm"
              allow_precompiled: true
      - name: envoy.filters.network.sni_dynamic_forward_proxy
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.sni_dynamic_forward_proxy.v3.FilterConfig
          # running dynamic_tls server at 19443
          port_value: 9443  # invalid port to test port override
          dns_cache_config:
            name: dynamic_forward_proxy_cache_config
            dns_lookup_family: V4_ONLY
      - name: envoy.tcp_proxy
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.tcp_proxy.v3.TcpProxy
          stat_prefix: tcp
          cluster: dynamic_forward_proxy_cluster
  clusters:
  - name: ext_authz
    connect_timeout: 0.25s
    type: STATIC
    max_requests_per_connection: 1
    load_assignment:
      cluster_name: ext_authz
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 9000
    typed_extension_protocol_options:
      envoy.extensions.upstreams.http.v3.HttpProtocolOptions:
        '@type': type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions
        explicit_http_config:
          http2_protocol_options: {}
  - name: dynamic_forward_proxy_cluster
    lb_policy: CLUSTER_PROVIDED
    cluster_type:
      name: envoy.clusters.dynamic_forward_proxy
      typed_config:
        "@type": type.googleapis.com/envoy.extensions.clusters.dynamic_forward_proxy.v3.ClusterConfig
        dns_cache_config:
          name: dynamic_forward_proxy_cache_config
          dns_lookup_family: V4_ONLY
  - name: waiter_service
    connect_timeout: 5s
    type: STATIC
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: waiter_service
      endpoints:
        - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: 127.0.0.1
                    port_value: 50001
